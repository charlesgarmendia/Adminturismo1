<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADMIN - FALC√ìN TURISMO VIVO</title>
    
    <!-- ========== MANIFEST EMBEBIDO ========== -->
    <link rel="manifest" href="data:application/manifest+json,%7B%22name%22%3A%22Falc%C3%B3n%20Turismo%20Vivo%20-%20Admin%22%2C%22short_name%22%3A%22Admin%20Turismo%22%2C%22description%22%3A%22Panel%20de%20gesti%C3%B3n%22%2C%22start_url%22%3A%22.%2F%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230a0a0a%22%2C%22theme_color%22%3A%22%23d4af37%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22administrador-512.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D">
    
    <meta name="theme-color" content="#d4af37">
    <link rel="apple-touch-icon" href="administrador-512.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root {
            --negro: #0a0a0a;
            --dorado: #d4af37;
            --verde: #1b5e20;
            --plateado: #c0c0c0;
            --rojo: #b71c1c;
            --azul: #0d47a1;
            --gris-oscuro: #1a1a1a;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: var(--negro);
            color: var(--plateado);
            font-family: 'Segoe UI', sans-serif;
            padding: 20px;
            margin: 0;
            padding-bottom: 100px;
        }
        
        h1 {
            color: var(--dorado);
            text-align: center;
            text-transform: uppercase;
            border-bottom: 2px solid var(--dorado);
            padding-bottom: 15px;
            margin-bottom: 25px;
            font-size: 1.8rem;
            letter-spacing: 3px;
        }
        
        /* ========== MEN√ö PRINCIPAL ========== */
        .menu-principal {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn-menu {
            background: linear-gradient(145deg, #1a1a1a, #0d0d0d);
            border: 2px solid var(--dorado);
            color: var(--dorado);
            padding: 12px 25px;
            border-radius: 40px;
            font-size: 1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 5px 0 #7a6a2c;
        }
        
        .btn-menu:hover {
            background: var(--dorado);
            color: var(--negro);
            transform: translateY(-3px);
            box-shadow: 0 8px 0 #7a6a2c;
        }
        
        .btn-menu i {
            font-size: 1.1rem;
        }
        
        .btn-menu.activo {
            background: var(--dorado);
            color: var(--negro);
            box-shadow: 0 3px 0 #7a6a2c;
            transform: translateY(2px);
        }
        
        /* ========== SECCIONES ========== */
        .seccion {
            display: none;
            background: #111;
            padding: 30px;
            border-radius: 25px;
            border: 1px solid #333;
            margin-top: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            animation: fadeIn 0.4s ease;
        }
        
        .seccion.activa {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .seccion h2 {
            color: var(--dorado);
            border-left: 8px solid var(--dorado);
            padding-left: 20px;
            margin-bottom: 25px;
            font-size: 1.8rem;
        }
        
        /* ========== ESTAD√çSTICAS ========== */
        .dashboard-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 40px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: var(--gris-oscuro);
            padding: 15px 20px;
            border-radius: 15px;
            border: 1px solid #333;
            text-align: center;
            transition: 0.3s;
            min-width: 180px;
            flex: 0 1 auto;
        }
        
        .stat-card:hover {
            border-color: var(--dorado);
            transform: scale(1.02);
        }
        
        .stat-number {
            font-size: 2.2rem;
            font-weight: 900;
            color: var(--dorado);
            line-height: 1;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #aaa;
            margin-top: 5px;
        }
        
        /* ========== FORMULARIO DE CREACI√ìN ========== */
        .input-moderno {
            width: 100%;
            padding: 15px;
            background: #222;
            border: 2px solid #444;
            color: white;
            border-radius: 15px;
            font-size: 1.1rem;
            margin-bottom: 20px;
            transition: 0.3s;
        }
        
        .input-moderno:focus {
            border-color: var(--dorado);
            outline: none;
            box-shadow: 0 0 15px rgba(212, 175, 55, 0.3);
        }
        
        .area-subida {
            border: 3px dashed var(--dorado);
            padding: 40px;
            text-align: center;
            border-radius: 20px;
            cursor: pointer;
            background: #1a1a1a;
            margin-bottom: 20px;
            transition: 0.3s;
        }
        
        .area-subida:hover {
            background: #222;
            border-color: #ffd700;
        }
        
        .area-subida i {
            font-size: 3rem;
            color: var(--dorado);
            margin-bottom: 15px;
        }
        
        /* ========== BOTONES ========== */
        .btn-primario {
            background: var(--verde);
            color: white;
            border: none;
            padding: 18px;
            width: 100%;
            border-radius: 15px;
            font-weight: bold;
            font-size: 1.2rem;
            cursor: pointer;
            transition: 0.3s;
            margin-top: 20px;
        }
        
        .btn-primario:hover {
            background: #2e7d32;
            transform: scale(1.02);
            box-shadow: 0 5px 20px rgba(30, 125, 30, 0.5);
        }
        
        /* ========== TARJETAS DE PERFIL ========== */
        .perfiles-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-top: 25px;
        }
        
        .tarjeta-perfil {
            background: var(--gris-oscuro);
            border-radius: 20px;
            padding: 18px;
            border: 1px solid #333;
            transition: 0.3s;
            display: flex;
            flex-direction: column;
        }
        
        .tarjeta-perfil:hover {
            border-color: var(--dorado);
            transform: translateY(-3px);
            box-shadow: 0 10px 20px rgba(212, 175, 55, 0.15);
        }
        
        .nombre-perfil {
            font-size: 1.2rem;
            color: var(--dorado);
            margin-bottom: 8px;
            font-weight: bold;
        }
        
        /* ========== BOTONES DE TARJETA ========== */
        .botones-tarjeta {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        .btn-tarjeta {
            border: none;
            padding: 8px 12px;
            border-radius: 30px;
            font-size: 0.8rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: 0.2s;
            flex: 1 0 auto;
            min-width: 100px;
        }
        
        .btn-tarjeta i {
            font-size: 0.8rem;
        }
        
        .btn-editar {
            background: var(--dorado);
            color: black;
        }
        
        .btn-eliminar {
            background: var(--rojo);
            color: white;
        }
        
        .btn-a√±adir {
            background: var(--verde);
            color: white;
        }
        
        .btn-tarjeta:hover {
            transform: translateY(-2px);
            filter: brightness(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        /* ========== BOT√ìN DESCARGA PWA ========== */
        #contenedor-instalar {
            display: none;
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 400px;
        }
        
        #btn-instalar {
            background: linear-gradient(145deg, #28a745, #1e7e34);
            color: white;
            border: 2px solid var(--plateado);
            padding: 18px;
            border-radius: 60px;
            width: 100%;
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            box-shadow: 0 8px 0 #0f4d1f;
            cursor: pointer;
            transition: 0.3s;
        }
        
        #btn-instalar:hover {
            transform: translateY(-3px);
            box-shadow: 0 11px 0 #0f4d1f;
        }
        
        /* ========== RESPONSIVE ========== */
        @media (max-width: 768px) {
            h1 { font-size: 1.4rem; }
            .btn-menu { 
                padding: 10px 20px; 
                font-size: 0.9rem; 
            }
            .stat-number { font-size: 1.8rem; }
            .stat-card { 
                min-width: 150px;
                padding: 12px 15px;
            }
            .perfiles-grid {
                grid-template-columns: 1fr;
            }
            .btn-tarjeta {
                min-width: 120px;
            }
        }
    </style>
</head>
<body>

    <h1><i class="fas fa-crown"></i> FALC√ìN TURISMO - ADMIN</h1>

    <!-- ========== MEN√ö PRINCIPAL ========== -->
    <div class="menu-principal">
        <button id="btn-estadistica" class="btn-menu activo">
            <i class="fas fa-chart-pie"></i> ESTAD√çSTICA
        </button>
        <button id="btn-crear-perfil" class="btn-menu">
            <i class="fas fa-plus-circle"></i> CREAR PERFIL
        </button>
    </div>

    <!-- ========== SECCI√ìN ESTAD√çSTICA ========== -->
    <div id="seccion-estadistica" class="seccion activa">
        <h2><i class="fas fa-chart-simple"></i> Panel de Control</h2>
        
        <div class="dashboard-stats">
            <div class="stat-card">
                <div class="stat-number" id="total-perfiles">0</div>
                <div class="stat-label">Perfiles Publicados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-archivos">0</div>
                <div class="stat-label">Archivos Multimedia</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-fotos">0</div>
                <div class="stat-label">Fotograf√≠as</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="total-videos">0</div>
                <div class="stat-label">Videos</div>
            </div>
        </div>

        <h3 style="color: var(--dorado); margin: 30px 0 20px;">
            <i class="fas fa-landmark"></i> Museos Registrados
        </h3>
        <div id="contenedor-perfiles" class="perfiles-grid">
            <div class="sin-perfiles">‚è≥ Cargando perfiles...</div>
        </div>
    </div>

    <!-- ========== SECCI√ìN CREAR/EDITAR PERFIL ========== -->
    <div id="seccion-crear" class="seccion">
        <h2><i class="fas fa-plus-square"></i> 
            <span id="titulo-form">Crear Nuevo Museo</span>
        </h2>
        
        <!-- Indicador modo edici√≥n -->
        <div id="modo-edicion-msg" style="display: none; background: var(--azul); padding: 15px; border-radius: 15px; margin-bottom: 20px;">
            <i class="fas fa-pen-to-square"></i> Editando: <strong id="editando-nombre"></strong>
        </div>
        <input type="hidden" id="perfil-id-edicion">

        <!-- Formulario -->
        <input type="text" id="nombre-museo" class="input-moderno" placeholder="üèõÔ∏è Nombre del Museo">
        
        <div class="area-subida" onclick="document.getElementById('archivos').click()">
            <i class="fas fa-cloud-upload-alt"></i>
            <h3 style="color: var(--dorado); margin-bottom: 10px;">Subir Multimedia</h3>
            <p style="color: #aaa;">Im√°genes, videos, documentos</p>
            <input type="file" id="archivos" multiple accept="image/*,video/*" style="display: none;" onchange="generarListaArchivos()">
        </div>

        <div id="lista-archivos-detallada"></div>

        <button class="btn-primario" id="btn-publicar">
            <i class="fas fa-cloud-upload-alt"></i> PUBLICAR EN FIRESTORE
        </button>
    </div>

    <!-- ========== BOT√ìN DE DESCARGA PWA ========== -->
    <div id="contenedor-instalar">
        <button id="btn-instalar">
            <i class="fas fa-download"></i> INSTALAR APLICACI√ìN
        </button>
    </div>

<script type="module">
    // ========== FIREBASE CONFIG ==========
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, updateDoc, query, orderBy, getDoc } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyBIMNw_d9IvniOC15bhgw8fXkl7L7T_Gpc",
        authDomain: "falconturismovivo.firebaseapp.com",
        projectId: "falconturismovivo",
        storageBucket: "falconturismovivo.firebasestorage.app",
        messagingSenderId: "162844055366",
        appId: "1:162844055366:web:b73c140d924fcff90d7747"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // ========== VARIABLES GLOBALES ==========
    let perfilEnEdicionId = null;
    let perfilEnEdicionNombre = "";
    let esEdicionCompleta = false;

    // ========== MEN√ö ENTRE SECCIONES ==========
    document.getElementById('btn-estadistica').addEventListener('click', () => {
        document.getElementById('btn-estadistica').classList.add('activo');
        document.getElementById('btn-crear-perfil').classList.remove('activo');
        document.getElementById('seccion-estadistica').classList.add('activa');
        document.getElementById('seccion-crear').classList.remove('activa');
        cargarPerfilesEstadistica();
    });

    document.getElementById('btn-crear-perfil').addEventListener('click', () => {
        document.getElementById('btn-crear-perfil').classList.add('activo');
        document.getElementById('btn-estadistica').classList.remove('activo');
        document.getElementById('seccion-crear').classList.add('activa');
        document.getElementById('seccion-estadistica').classList.remove('activa');
        salirModoEdicion();
    });

    // ========== COMPRESOR DE IM√ÅGENES ==========
    async function comprimirImagen(file) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;
                    
                    if (width > 1200) {
                        height = (1200 * height) / width;
                        width = 1200;
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    const base64 = canvas.toDataURL('image/jpeg', 0.7);
                    resolve(base64);
                };
            };
        });
    }

    // ========== GENERAR LISTA DE ARCHIVOS CON BASE64 ==========
    window.generarListaArchivos = async () => {
        const input = document.getElementById('archivos');
        const contenedor = document.getElementById('lista-archivos-detallada');
        contenedor.innerHTML = "";
        
        for (const file of Array.from(input.files)) {
            const div = document.createElement('div');
            div.className = 'archivo-item';
            
            if (file.type.includes('image')) {
                const base64 = await comprimirImagen(file);
                div.innerHTML = `
                    <div class="fila-archivo">
                        <img src="${base64}">
                        <div style="flex:1">
                            <small style="color:var(--dorado);">üì∏ ${file.name}</small>
                            <input type="text" class="desc-individual" placeholder="Descripci√≥n de esta imagen" style="margin-top:8px;">
                            <input type="hidden" class="base64-data" value="${base64}">
                            <input type="hidden" class="tipo-archivo" value="image">
                        </div>
                    </div>
                `;
            } else if (file.type.includes('video')) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                await new Promise(resolve => { reader.onload = resolve; });
                div.innerHTML = `
                    <div class="fila-archivo">
                        <video src="${reader.result}" style="width:80px; height:80px; object-fit:cover;"></video>
                        <div style="flex:1">
                            <small style="color:var(--dorado);">üé¨ ${file.name}</small>
                            <input type="text" class="desc-individual" placeholder="Descripci√≥n de este video" style="margin-top:8px;">
                            <input type="hidden" class="base64-data" value="${reader.result}">
                            <input type="hidden" class="tipo-archivo" value="video">
                        </div>
                    </div>
                `;
            }
            contenedor.appendChild(div);
        }
    };

    // ========== PUBLICAR EN FIRESTORE - √öNICA L√çNEA CORREGIDA ==========
    document.getElementById('btn-publicar').onclick = async () => {
        const nombreMuseo = document.getElementById('nombre-museo').value.trim();
        const descs = document.querySelectorAll('.desc-individual');
        const base64s = document.querySelectorAll('.base64-data');
        const tipos = document.querySelectorAll('.tipo-archivo');
        
        if (!nombreMuseo) { alert('‚ùå Escribe el nombre del museo'); return; }
        if (base64s.length === 0) { alert('‚ùå Selecciona al menos un archivo'); return; }

        const btn = document.getElementById('btn-publicar');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> PUBLICANDO...';

        try {
            const archivos = [];
            for (let i = 0; i < base64s.length; i++) {
                archivos.push({
                    base64: base64s[i].value,
                    descripcion: descs[i]?.value || 'Sin descripci√≥n',
                    tipo: tipos[i]?.value || 'image',
                    timestamp: Date.now()
                });
            }

            // ===== √öNICA L√çNEA CORREGIDA =====
            // ANTES: if (perfilEnEdicionId) {
            // AHORA: 
            if (perfilEnEdicionId && perfilEnEdicionId !== "") {
                // MODO EDICI√ìN - Actualizar perfil existente
                const perfilRef = doc(db, "perfiles", perfilEnEdicionId);
                
                if (esEdicionCompleta) {
                    // Edici√≥n completa - reemplazar todo
                    await updateDoc(perfilRef, {
                        nombre: nombreMuseo,
                        archivos: archivos,
                        fecha_edicion: new Date()
                    });
                    alert(`‚úÖ Perfil "${nombreMuseo}" actualizado completamente`);
                } else {
                    // Solo a√±adir archivos
                    const docSnap = await getDoc(perfilRef);
                    if (docSnap.exists()) {
                        const archivosPrevios = docSnap.data().archivos || [];
                        await updateDoc(perfilRef, {
                            archivos: [...archivosPrevios, ...archivos],
                            fecha_edicion: new Date()
                        });
                        alert(`‚úÖ Multimedia a√±adido a "${perfilEnEdicionNombre}"`);
                    }
                }
            } else {
                // NUEVO PERFIL - Crear nuevo documento
                await addDoc(collection(db, "perfiles"), {
                    nombre: nombreMuseo,
                    archivos: archivos,
                    fecha: new Date(),
                    timestamp: Date.now()
                });
                alert(`‚úÖ Museo "${nombreMuseo}" creado con ${archivos.length} archivos`);
            }

            // Limpiar formulario
            document.getElementById('nombre-museo').value = '';
            document.getElementById('archivos').value = '';
            document.getElementById('lista-archivos-detallada').innerHTML = '';
            
            // Salir del modo edici√≥n
            salirModoEdicion();
            
            // Cambiar a vista de estad√≠sticas
            document.getElementById('btn-estadistica').click();
            
        } catch (error) {
            console.error(error);
            alert('‚ùå Error: ' + error.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-cloud-upload-alt"></i> PUBLICAR EN FIRESTORE';
        }
    };

    // ========== CARGAR ESTAD√çSTICAS Y PERFILES ==========
    window.cargarPerfilesEstadistica = async () => {
        try {
            const querySnapshot = await getDocs(query(collection(db, "perfiles"), orderBy("fecha", "desc")));
            
            let totalArchivos = 0;
            let totalFotos = 0;
            let totalVideos = 0;
            
            querySnapshot.forEach(doc => {
                const archivos = doc.data().archivos || [];
                totalArchivos += archivos.length;
                totalFotos += archivos.filter(a => a.tipo === 'image').length;
                totalVideos += archivos.filter(a => a.tipo === 'video').length;
            });
            
            document.getElementById('total-perfiles').innerText = querySnapshot.size;
            document.getElementById('total-archivos').innerText = totalArchivos;
            document.getElementById('total-fotos').innerText = totalFotos;
            document.getElementById('total-videos').innerText = totalVideos;

            const contenedor = document.getElementById('contenedor-perfiles');
            let html = '';
            
            querySnapshot.forEach((docSnap) => {
                const p = docSnap.data();
                const archivos = p.archivos || [];
                const fecha = p.fecha ? new Date(p.fecha.seconds * 1000).toLocaleDateString('es-ES') : 'Fecha desconocida';
                
                html += `
                <div class="tarjeta-perfil">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <span class="nombre-perfil">üèõÔ∏è ${p.nombre}</span>
                        <span style="background: var(--dorado); color: black; padding: 4px 10px; border-radius: 50px; font-size: 0.8rem; font-weight: bold;">
                            ${archivos.length} archivos
                        </span>
                    </div>
                    <div style="margin: 10px 0; color: #aaa; font-size: 0.8rem;">
                        <i class="far fa-calendar-alt"></i> ${fecha}
                    </div>
                    <div class="botones-tarjeta">
                        <button onclick="editarPerfilCompleto('${docSnap.id}', '${p.nombre.replace(/'/g, "\\'")}')" class="btn-tarjeta btn-editar">
                            <i class="fas fa-pencil-alt"></i> Editar
                        </button>
                        <button onclick="eliminarPerfil('${docSnap.id}')" class="btn-tarjeta btn-eliminar">
                            <i class="fas fa-trash-alt"></i> Eliminar
                        </button>
                        <button onclick="a√±adirArchivos('${docSnap.id}', '${p.nombre.replace(/'/g, "\\'")}')" class="btn-tarjeta btn-a√±adir">
                            <i class="fas fa-plus-circle"></i> A√±adir
                        </button>
                    </div>
                </div>
                `;
            });
            
            contenedor.innerHTML = html || '<div class="sin-perfiles">‚ú® No hay museos creados</div>';
            
        } catch (e) {
            console.error(e);
        }
    };

    // ========== FUNCIONES DE LOS BOTONES ==========
    window.editarPerfilCompleto = (perfilId, nombrePerfil) => {
        salirModoEdicion();
        perfilEnEdicionId = perfilId;
        perfilEnEdicionNombre = nombrePerfil;
        esEdicionCompleta = true;
        
        document.getElementById('modo-edicion-msg').style.display = 'block';
        document.getElementById('editando-nombre').innerText = nombrePerfil;
        document.getElementById('perfil-id-edicion').value = perfilId;
        document.getElementById('titulo-form').innerHTML = 'Editando: ' + nombrePerfil;
        document.getElementById('nombre-museo').value = nombrePerfil;
        
        document.getElementById('archivos').value = '';
        document.getElementById('lista-archivos-detallada').innerHTML = '';
        
        document.getElementById('btn-crear-perfil').click();
    };

    window.a√±adirArchivos = (perfilId, nombrePerfil) => {
        salirModoEdicion();
        perfilEnEdicionId = perfilId;
        perfilEnEdicionNombre = nombrePerfil;
        esEdicionCompleta = false;
        
        document.getElementById('modo-edicion-msg').style.display = 'block';
        document.getElementById('editando-nombre').innerText = nombrePerfil;
        document.getElementById('perfil-id-edicion').value = perfilId;
        document.getElementById('titulo-form').innerHTML = 'A√±adir archivos a: ' + nombrePerfil;
        document.getElementById('nombre-museo').value = nombrePerfil + ' (agregar m√°s)';
        
        document.getElementById('btn-crear-perfil').click();
    };

    // ========== ELIMINAR PERFIL ==========
    window.eliminarPerfil = async (perfilId) => {
        if (confirm('‚ö†Ô∏è ¬øEliminar este museo permanentemente?')) {
            await deleteDoc(doc(db, "perfiles", perfilId));
            cargarPerfilesEstadistica();
        }
    };

    // ========== SALIR MODO EDICI√ìN ==========
    window.salirModoEdicion = () => {
        perfilEnEdicionId = null;
        perfilEnEdicionNombre = "";
        esEdicionCompleta = false;
        document.getElementById('perfil-id-edicion').value = '';
        document.getElementById('modo-edicion-msg').style.display = 'none';
        document.getElementById('titulo-form').innerHTML = 'Crear Nuevo Museo';
        document.getElementById('nombre-museo').value = '';
        document.getElementById('archivos').value = '';
        document.getElementById('lista-archivos-detallada').innerHTML = '';
    };

    // ========== PWA INSTALL ==========
    let promptInstala;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        promptInstala = e;
        if (!window.matchMedia('(display-mode: standalone)').matches) {
            document.getElementById('contenedor-instalar').style.display = 'block';
        }
    });

    document.getElementById('btn-instalar').onclick = async () => {
        if (promptInstala) {
            promptInstala.prompt();
            const { outcome } = await promptInstala.userChoice;
            if (outcome === 'accepted') {
                document.getElementById('contenedor-instalar').style.display = 'none';
            }
        }
    };

    if (window.matchMedia('(display-mode: standalone)').matches) {
        document.getElementById('contenedor-instalar').style.display = 'none';
    }

    // ========== SERVICE WORKER ==========
    if ('serviceWorker' in navigator) {
        const swScript = `const C='falcon-admin-v2';const U=['.','https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css'];self.addEventListener('install',e=>e.waitUntil(caches.open(C).then(c=>c.addAll(U))));self.addEventListener('fetch',e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));`;
        const blob = new Blob([swScript], { type: 'application/javascript' });
        navigator.serviceWorker.register(URL.createObjectURL(blob), { scope: './' }).catch(() => {});
    }

    // ========== INICIALIZAR ==========
    cargarPerfilesEstadistica();
    window.salirModoEdicion = salirModoEdicion;
</script>

</body>
</html>